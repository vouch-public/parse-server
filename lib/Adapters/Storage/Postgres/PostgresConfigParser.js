"use strict";

const url = require('url');

const fs = require('fs');

function getDatabaseOptionsFromURI(uri) {
  const databaseOptions = {};
  const parsedURI = url.parse(uri);
  const queryParams = parseQueryParams(parsedURI.query);
  const authParts = parsedURI.auth ? parsedURI.auth.split(':') : [];
  databaseOptions.host = parsedURI.hostname || 'localhost';
  databaseOptions.port = parsedURI.port ? parseInt(parsedURI.port) : 5432;
  databaseOptions.database = parsedURI.pathname ? parsedURI.pathname.substr(1) : undefined;
  databaseOptions.user = authParts.length > 0 ? authParts[0] : '';
  databaseOptions.password = authParts.length > 1 ? authParts[1] : '';

  if (queryParams.ssl && queryParams.ssl.toLowerCase() === 'true') {
    databaseOptions.ssl = true;
  }

  if (queryParams.ca || queryParams.pfx || queryParams.cert || queryParams.key || queryParams.passphrase || queryParams.rejectUnauthorized || queryParams.secureOptions) {
    databaseOptions.ssl = {};

    if (queryParams.ca) {
      databaseOptions.ssl.ca = fs.readFileSync(queryParams.ca).toString();
    }

    if (queryParams.pfx) {
      databaseOptions.ssl.pfx = fs.readFileSync(queryParams.pfx).toString();
    }

    if (queryParams.cert) {
      databaseOptions.ssl.cert = fs.readFileSync(queryParams.cert).toString();
    }

    if (queryParams.key) {
      databaseOptions.ssl.key = fs.readFileSync(queryParams.key).toString();
    }

    if (queryParams.passphrase) {
      databaseOptions.ssl.passphrase = queryParams.passphrase;
    }

    if (queryParams.rejectUnauthorized) {
      databaseOptions.ssl.rejectUnauthorized = queryParams.rejectUnauthorized.toLowerCase() === 'true' ? true : false;
    }

    if (queryParams.secureOptions) {
      databaseOptions.ssl.secureOptions = parseInt(queryParams.secureOptions);
    }
  }

  databaseOptions.binary = queryParams.binary && queryParams.binary.toLowerCase() === 'true' ? true : false;
  databaseOptions.client_encoding = queryParams.client_encoding;
  databaseOptions.application_name = queryParams.application_name;
  databaseOptions.fallback_application_name = queryParams.fallback_application_name;

  if (queryParams.poolSize) {
    databaseOptions.poolSize = parseInt(queryParams.poolSize) || 10;
  }

  if (queryParams.max) {
    databaseOptions.max = parseInt(queryParams.max) || 10;
  }

  if (queryParams.query_timeout) {
    databaseOptions.query_timeout = parseInt(queryParams.query_timeout);
  }

  if (queryParams.idleTimeoutMillis) {
    databaseOptions.idleTimeoutMillis = parseInt(queryParams.idleTimeoutMillis);
  }

  if (queryParams.keepAlive) {
    databaseOptions.keepAlive = queryParams.keepAlive.toLowerCase() === 'true' ? true : false;
  }

  return databaseOptions;
}

function parseQueryParams(queryString) {
  queryString = queryString || '';
  return queryString.split('&').reduce((p, c) => {
    const parts = c.split('=');
    p[decodeURIComponent(parts[0])] = parts.length > 1 ? decodeURIComponent(parts.slice(1).join('=')) : '';
    return p;
  }, {});
}

module.exports = {
  parseQueryParams: parseQueryParams,
  getDatabaseOptionsFromURI: getDatabaseOptionsFromURI
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL1Bvc3RncmVzL1Bvc3RncmVzQ29uZmlnUGFyc2VyLmpzIl0sIm5hbWVzIjpbInVybCIsInJlcXVpcmUiLCJmcyIsImdldERhdGFiYXNlT3B0aW9uc0Zyb21VUkkiLCJ1cmkiLCJkYXRhYmFzZU9wdGlvbnMiLCJwYXJzZWRVUkkiLCJwYXJzZSIsInF1ZXJ5UGFyYW1zIiwicGFyc2VRdWVyeVBhcmFtcyIsInF1ZXJ5IiwiYXV0aFBhcnRzIiwiYXV0aCIsInNwbGl0IiwiaG9zdCIsImhvc3RuYW1lIiwicG9ydCIsInBhcnNlSW50IiwiZGF0YWJhc2UiLCJwYXRobmFtZSIsInN1YnN0ciIsInVuZGVmaW5lZCIsInVzZXIiLCJsZW5ndGgiLCJwYXNzd29yZCIsInNzbCIsInRvTG93ZXJDYXNlIiwiY2EiLCJwZngiLCJjZXJ0Iiwia2V5IiwicGFzc3BocmFzZSIsInJlamVjdFVuYXV0aG9yaXplZCIsInNlY3VyZU9wdGlvbnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsImJpbmFyeSIsImNsaWVudF9lbmNvZGluZyIsImFwcGxpY2F0aW9uX25hbWUiLCJmYWxsYmFja19hcHBsaWNhdGlvbl9uYW1lIiwicG9vbFNpemUiLCJtYXgiLCJxdWVyeV90aW1lb3V0IiwiaWRsZVRpbWVvdXRNaWxsaXMiLCJrZWVwQWxpdmUiLCJxdWVyeVN0cmluZyIsInJlZHVjZSIsInAiLCJjIiwicGFydHMiLCJkZWNvZGVVUklDb21wb25lbnQiLCJzbGljZSIsImpvaW4iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLEdBQUcsR0FBR0MsT0FBTyxDQUFDLEtBQUQsQ0FBbkI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxTQUFTRSx5QkFBVCxDQUFtQ0MsR0FBbkMsRUFBd0M7QUFDdEMsUUFBTUMsZUFBZSxHQUFHLEVBQXhCO0FBRUEsUUFBTUMsU0FBUyxHQUFHTixHQUFHLENBQUNPLEtBQUosQ0FBVUgsR0FBVixDQUFsQjtBQUNBLFFBQU1JLFdBQVcsR0FBR0MsZ0JBQWdCLENBQUNILFNBQVMsQ0FBQ0ksS0FBWCxDQUFwQztBQUNBLFFBQU1DLFNBQVMsR0FBR0wsU0FBUyxDQUFDTSxJQUFWLEdBQWlCTixTQUFTLENBQUNNLElBQVYsQ0FBZUMsS0FBZixDQUFxQixHQUFyQixDQUFqQixHQUE2QyxFQUEvRDtBQUVBUixFQUFBQSxlQUFlLENBQUNTLElBQWhCLEdBQXVCUixTQUFTLENBQUNTLFFBQVYsSUFBc0IsV0FBN0M7QUFDQVYsRUFBQUEsZUFBZSxDQUFDVyxJQUFoQixHQUF1QlYsU0FBUyxDQUFDVSxJQUFWLEdBQWlCQyxRQUFRLENBQUNYLFNBQVMsQ0FBQ1UsSUFBWCxDQUF6QixHQUE0QyxJQUFuRTtBQUNBWCxFQUFBQSxlQUFlLENBQUNhLFFBQWhCLEdBQTJCWixTQUFTLENBQUNhLFFBQVYsR0FBcUJiLFNBQVMsQ0FBQ2EsUUFBVixDQUFtQkMsTUFBbkIsQ0FBMEIsQ0FBMUIsQ0FBckIsR0FBb0RDLFNBQS9FO0FBRUFoQixFQUFBQSxlQUFlLENBQUNpQixJQUFoQixHQUF1QlgsU0FBUyxDQUFDWSxNQUFWLEdBQW1CLENBQW5CLEdBQXVCWixTQUFTLENBQUMsQ0FBRCxDQUFoQyxHQUFzQyxFQUE3RDtBQUNBTixFQUFBQSxlQUFlLENBQUNtQixRQUFoQixHQUEyQmIsU0FBUyxDQUFDWSxNQUFWLEdBQW1CLENBQW5CLEdBQXVCWixTQUFTLENBQUMsQ0FBRCxDQUFoQyxHQUFzQyxFQUFqRTs7QUFFQSxNQUFJSCxXQUFXLENBQUNpQixHQUFaLElBQW1CakIsV0FBVyxDQUFDaUIsR0FBWixDQUFnQkMsV0FBaEIsT0FBa0MsTUFBekQsRUFBaUU7QUFDL0RyQixJQUFBQSxlQUFlLENBQUNvQixHQUFoQixHQUFzQixJQUF0QjtBQUNEOztBQUVELE1BQ0VqQixXQUFXLENBQUNtQixFQUFaLElBQ0FuQixXQUFXLENBQUNvQixHQURaLElBRUFwQixXQUFXLENBQUNxQixJQUZaLElBR0FyQixXQUFXLENBQUNzQixHQUhaLElBSUF0QixXQUFXLENBQUN1QixVQUpaLElBS0F2QixXQUFXLENBQUN3QixrQkFMWixJQU1BeEIsV0FBVyxDQUFDeUIsYUFQZCxFQVFFO0FBQ0E1QixJQUFBQSxlQUFlLENBQUNvQixHQUFoQixHQUFzQixFQUF0Qjs7QUFDQSxRQUFJakIsV0FBVyxDQUFDbUIsRUFBaEIsRUFBb0I7QUFDbEJ0QixNQUFBQSxlQUFlLENBQUNvQixHQUFoQixDQUFvQkUsRUFBcEIsR0FBeUJ6QixFQUFFLENBQUNnQyxZQUFILENBQWdCMUIsV0FBVyxDQUFDbUIsRUFBNUIsRUFBZ0NRLFFBQWhDLEVBQXpCO0FBQ0Q7O0FBQ0QsUUFBSTNCLFdBQVcsQ0FBQ29CLEdBQWhCLEVBQXFCO0FBQ25CdkIsTUFBQUEsZUFBZSxDQUFDb0IsR0FBaEIsQ0FBb0JHLEdBQXBCLEdBQTBCMUIsRUFBRSxDQUFDZ0MsWUFBSCxDQUFnQjFCLFdBQVcsQ0FBQ29CLEdBQTVCLEVBQWlDTyxRQUFqQyxFQUExQjtBQUNEOztBQUNELFFBQUkzQixXQUFXLENBQUNxQixJQUFoQixFQUFzQjtBQUNwQnhCLE1BQUFBLGVBQWUsQ0FBQ29CLEdBQWhCLENBQW9CSSxJQUFwQixHQUEyQjNCLEVBQUUsQ0FBQ2dDLFlBQUgsQ0FBZ0IxQixXQUFXLENBQUNxQixJQUE1QixFQUFrQ00sUUFBbEMsRUFBM0I7QUFDRDs7QUFDRCxRQUFJM0IsV0FBVyxDQUFDc0IsR0FBaEIsRUFBcUI7QUFDbkJ6QixNQUFBQSxlQUFlLENBQUNvQixHQUFoQixDQUFvQkssR0FBcEIsR0FBMEI1QixFQUFFLENBQUNnQyxZQUFILENBQWdCMUIsV0FBVyxDQUFDc0IsR0FBNUIsRUFBaUNLLFFBQWpDLEVBQTFCO0FBQ0Q7O0FBQ0QsUUFBSTNCLFdBQVcsQ0FBQ3VCLFVBQWhCLEVBQTRCO0FBQzFCMUIsTUFBQUEsZUFBZSxDQUFDb0IsR0FBaEIsQ0FBb0JNLFVBQXBCLEdBQWlDdkIsV0FBVyxDQUFDdUIsVUFBN0M7QUFDRDs7QUFDRCxRQUFJdkIsV0FBVyxDQUFDd0Isa0JBQWhCLEVBQW9DO0FBQ2xDM0IsTUFBQUEsZUFBZSxDQUFDb0IsR0FBaEIsQ0FBb0JPLGtCQUFwQixHQUNFeEIsV0FBVyxDQUFDd0Isa0JBQVosQ0FBK0JOLFdBQS9CLE9BQWlELE1BQWpELEdBQTBELElBQTFELEdBQWlFLEtBRG5FO0FBRUQ7O0FBQ0QsUUFBSWxCLFdBQVcsQ0FBQ3lCLGFBQWhCLEVBQStCO0FBQzdCNUIsTUFBQUEsZUFBZSxDQUFDb0IsR0FBaEIsQ0FBb0JRLGFBQXBCLEdBQW9DaEIsUUFBUSxDQUFDVCxXQUFXLENBQUN5QixhQUFiLENBQTVDO0FBQ0Q7QUFDRjs7QUFFRDVCLEVBQUFBLGVBQWUsQ0FBQytCLE1BQWhCLEdBQ0U1QixXQUFXLENBQUM0QixNQUFaLElBQXNCNUIsV0FBVyxDQUFDNEIsTUFBWixDQUFtQlYsV0FBbkIsT0FBcUMsTUFBM0QsR0FBb0UsSUFBcEUsR0FBMkUsS0FEN0U7QUFHQXJCLEVBQUFBLGVBQWUsQ0FBQ2dDLGVBQWhCLEdBQWtDN0IsV0FBVyxDQUFDNkIsZUFBOUM7QUFDQWhDLEVBQUFBLGVBQWUsQ0FBQ2lDLGdCQUFoQixHQUFtQzlCLFdBQVcsQ0FBQzhCLGdCQUEvQztBQUNBakMsRUFBQUEsZUFBZSxDQUFDa0MseUJBQWhCLEdBQTRDL0IsV0FBVyxDQUFDK0IseUJBQXhEOztBQUVBLE1BQUkvQixXQUFXLENBQUNnQyxRQUFoQixFQUEwQjtBQUN4Qm5DLElBQUFBLGVBQWUsQ0FBQ21DLFFBQWhCLEdBQTJCdkIsUUFBUSxDQUFDVCxXQUFXLENBQUNnQyxRQUFiLENBQVIsSUFBa0MsRUFBN0Q7QUFDRDs7QUFDRCxNQUFJaEMsV0FBVyxDQUFDaUMsR0FBaEIsRUFBcUI7QUFDbkJwQyxJQUFBQSxlQUFlLENBQUNvQyxHQUFoQixHQUFzQnhCLFFBQVEsQ0FBQ1QsV0FBVyxDQUFDaUMsR0FBYixDQUFSLElBQTZCLEVBQW5EO0FBQ0Q7O0FBQ0QsTUFBSWpDLFdBQVcsQ0FBQ2tDLGFBQWhCLEVBQStCO0FBQzdCckMsSUFBQUEsZUFBZSxDQUFDcUMsYUFBaEIsR0FBZ0N6QixRQUFRLENBQUNULFdBQVcsQ0FBQ2tDLGFBQWIsQ0FBeEM7QUFDRDs7QUFDRCxNQUFJbEMsV0FBVyxDQUFDbUMsaUJBQWhCLEVBQW1DO0FBQ2pDdEMsSUFBQUEsZUFBZSxDQUFDc0MsaUJBQWhCLEdBQW9DMUIsUUFBUSxDQUFDVCxXQUFXLENBQUNtQyxpQkFBYixDQUE1QztBQUNEOztBQUNELE1BQUluQyxXQUFXLENBQUNvQyxTQUFoQixFQUEyQjtBQUN6QnZDLElBQUFBLGVBQWUsQ0FBQ3VDLFNBQWhCLEdBQTRCcEMsV0FBVyxDQUFDb0MsU0FBWixDQUFzQmxCLFdBQXRCLE9BQXdDLE1BQXhDLEdBQWlELElBQWpELEdBQXdELEtBQXBGO0FBQ0Q7O0FBRUQsU0FBT3JCLGVBQVA7QUFDRDs7QUFFRCxTQUFTSSxnQkFBVCxDQUEwQm9DLFdBQTFCLEVBQXVDO0FBQ3JDQSxFQUFBQSxXQUFXLEdBQUdBLFdBQVcsSUFBSSxFQUE3QjtBQUVBLFNBQU9BLFdBQVcsQ0FBQ2hDLEtBQVosQ0FBa0IsR0FBbEIsRUFBdUJpQyxNQUF2QixDQUE4QixDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVTtBQUM3QyxVQUFNQyxLQUFLLEdBQUdELENBQUMsQ0FBQ25DLEtBQUYsQ0FBUSxHQUFSLENBQWQ7QUFDQWtDLElBQUFBLENBQUMsQ0FBQ0csa0JBQWtCLENBQUNELEtBQUssQ0FBQyxDQUFELENBQU4sQ0FBbkIsQ0FBRCxHQUNFQSxLQUFLLENBQUMxQixNQUFOLEdBQWUsQ0FBZixHQUFtQjJCLGtCQUFrQixDQUFDRCxLQUFLLENBQUNFLEtBQU4sQ0FBWSxDQUFaLEVBQWVDLElBQWYsQ0FBb0IsR0FBcEIsQ0FBRCxDQUFyQyxHQUFrRSxFQURwRTtBQUVBLFdBQU9MLENBQVA7QUFDRCxHQUxNLEVBS0osRUFMSSxDQUFQO0FBTUQ7O0FBRURNLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUNmN0MsRUFBQUEsZ0JBQWdCLEVBQUVBLGdCQURIO0FBRWZOLEVBQUFBLHlCQUF5QixFQUFFQTtBQUZaLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgdXJsID0gcmVxdWlyZSgndXJsJyk7XG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5mdW5jdGlvbiBnZXREYXRhYmFzZU9wdGlvbnNGcm9tVVJJKHVyaSkge1xuICBjb25zdCBkYXRhYmFzZU9wdGlvbnMgPSB7fTtcblxuICBjb25zdCBwYXJzZWRVUkkgPSB1cmwucGFyc2UodXJpKTtcbiAgY29uc3QgcXVlcnlQYXJhbXMgPSBwYXJzZVF1ZXJ5UGFyYW1zKHBhcnNlZFVSSS5xdWVyeSk7XG4gIGNvbnN0IGF1dGhQYXJ0cyA9IHBhcnNlZFVSSS5hdXRoID8gcGFyc2VkVVJJLmF1dGguc3BsaXQoJzonKSA6IFtdO1xuXG4gIGRhdGFiYXNlT3B0aW9ucy5ob3N0ID0gcGFyc2VkVVJJLmhvc3RuYW1lIHx8ICdsb2NhbGhvc3QnO1xuICBkYXRhYmFzZU9wdGlvbnMucG9ydCA9IHBhcnNlZFVSSS5wb3J0ID8gcGFyc2VJbnQocGFyc2VkVVJJLnBvcnQpIDogNTQzMjtcbiAgZGF0YWJhc2VPcHRpb25zLmRhdGFiYXNlID0gcGFyc2VkVVJJLnBhdGhuYW1lID8gcGFyc2VkVVJJLnBhdGhuYW1lLnN1YnN0cigxKSA6IHVuZGVmaW5lZDtcblxuICBkYXRhYmFzZU9wdGlvbnMudXNlciA9IGF1dGhQYXJ0cy5sZW5ndGggPiAwID8gYXV0aFBhcnRzWzBdIDogJyc7XG4gIGRhdGFiYXNlT3B0aW9ucy5wYXNzd29yZCA9IGF1dGhQYXJ0cy5sZW5ndGggPiAxID8gYXV0aFBhcnRzWzFdIDogJyc7XG5cbiAgaWYgKHF1ZXJ5UGFyYW1zLnNzbCAmJiBxdWVyeVBhcmFtcy5zc2wudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnKSB7XG4gICAgZGF0YWJhc2VPcHRpb25zLnNzbCA9IHRydWU7XG4gIH1cblxuICBpZiAoXG4gICAgcXVlcnlQYXJhbXMuY2EgfHxcbiAgICBxdWVyeVBhcmFtcy5wZnggfHxcbiAgICBxdWVyeVBhcmFtcy5jZXJ0IHx8XG4gICAgcXVlcnlQYXJhbXMua2V5IHx8XG4gICAgcXVlcnlQYXJhbXMucGFzc3BocmFzZSB8fFxuICAgIHF1ZXJ5UGFyYW1zLnJlamVjdFVuYXV0aG9yaXplZCB8fFxuICAgIHF1ZXJ5UGFyYW1zLnNlY3VyZU9wdGlvbnNcbiAgKSB7XG4gICAgZGF0YWJhc2VPcHRpb25zLnNzbCA9IHt9O1xuICAgIGlmIChxdWVyeVBhcmFtcy5jYSkge1xuICAgICAgZGF0YWJhc2VPcHRpb25zLnNzbC5jYSA9IGZzLnJlYWRGaWxlU3luYyhxdWVyeVBhcmFtcy5jYSkudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgaWYgKHF1ZXJ5UGFyYW1zLnBmeCkge1xuICAgICAgZGF0YWJhc2VPcHRpb25zLnNzbC5wZnggPSBmcy5yZWFkRmlsZVN5bmMocXVlcnlQYXJhbXMucGZ4KS50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAocXVlcnlQYXJhbXMuY2VydCkge1xuICAgICAgZGF0YWJhc2VPcHRpb25zLnNzbC5jZXJ0ID0gZnMucmVhZEZpbGVTeW5jKHF1ZXJ5UGFyYW1zLmNlcnQpLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGlmIChxdWVyeVBhcmFtcy5rZXkpIHtcbiAgICAgIGRhdGFiYXNlT3B0aW9ucy5zc2wua2V5ID0gZnMucmVhZEZpbGVTeW5jKHF1ZXJ5UGFyYW1zLmtleSkudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgaWYgKHF1ZXJ5UGFyYW1zLnBhc3NwaHJhc2UpIHtcbiAgICAgIGRhdGFiYXNlT3B0aW9ucy5zc2wucGFzc3BocmFzZSA9IHF1ZXJ5UGFyYW1zLnBhc3NwaHJhc2U7XG4gICAgfVxuICAgIGlmIChxdWVyeVBhcmFtcy5yZWplY3RVbmF1dGhvcml6ZWQpIHtcbiAgICAgIGRhdGFiYXNlT3B0aW9ucy5zc2wucmVqZWN0VW5hdXRob3JpemVkID1cbiAgICAgICAgcXVlcnlQYXJhbXMucmVqZWN0VW5hdXRob3JpemVkLnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJyA/IHRydWUgOiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHF1ZXJ5UGFyYW1zLnNlY3VyZU9wdGlvbnMpIHtcbiAgICAgIGRhdGFiYXNlT3B0aW9ucy5zc2wuc2VjdXJlT3B0aW9ucyA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLnNlY3VyZU9wdGlvbnMpO1xuICAgIH1cbiAgfVxuXG4gIGRhdGFiYXNlT3B0aW9ucy5iaW5hcnkgPVxuICAgIHF1ZXJ5UGFyYW1zLmJpbmFyeSAmJiBxdWVyeVBhcmFtcy5iaW5hcnkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnID8gdHJ1ZSA6IGZhbHNlO1xuXG4gIGRhdGFiYXNlT3B0aW9ucy5jbGllbnRfZW5jb2RpbmcgPSBxdWVyeVBhcmFtcy5jbGllbnRfZW5jb2Rpbmc7XG4gIGRhdGFiYXNlT3B0aW9ucy5hcHBsaWNhdGlvbl9uYW1lID0gcXVlcnlQYXJhbXMuYXBwbGljYXRpb25fbmFtZTtcbiAgZGF0YWJhc2VPcHRpb25zLmZhbGxiYWNrX2FwcGxpY2F0aW9uX25hbWUgPSBxdWVyeVBhcmFtcy5mYWxsYmFja19hcHBsaWNhdGlvbl9uYW1lO1xuXG4gIGlmIChxdWVyeVBhcmFtcy5wb29sU2l6ZSkge1xuICAgIGRhdGFiYXNlT3B0aW9ucy5wb29sU2l6ZSA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLnBvb2xTaXplKSB8fCAxMDtcbiAgfVxuICBpZiAocXVlcnlQYXJhbXMubWF4KSB7XG4gICAgZGF0YWJhc2VPcHRpb25zLm1heCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLm1heCkgfHwgMTA7XG4gIH1cbiAgaWYgKHF1ZXJ5UGFyYW1zLnF1ZXJ5X3RpbWVvdXQpIHtcbiAgICBkYXRhYmFzZU9wdGlvbnMucXVlcnlfdGltZW91dCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLnF1ZXJ5X3RpbWVvdXQpO1xuICB9XG4gIGlmIChxdWVyeVBhcmFtcy5pZGxlVGltZW91dE1pbGxpcykge1xuICAgIGRhdGFiYXNlT3B0aW9ucy5pZGxlVGltZW91dE1pbGxpcyA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmlkbGVUaW1lb3V0TWlsbGlzKTtcbiAgfVxuICBpZiAocXVlcnlQYXJhbXMua2VlcEFsaXZlKSB7XG4gICAgZGF0YWJhc2VPcHRpb25zLmtlZXBBbGl2ZSA9IHF1ZXJ5UGFyYW1zLmtlZXBBbGl2ZS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZScgPyB0cnVlIDogZmFsc2U7XG4gIH1cblxuICByZXR1cm4gZGF0YWJhc2VPcHRpb25zO1xufVxuXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5UGFyYW1zKHF1ZXJ5U3RyaW5nKSB7XG4gIHF1ZXJ5U3RyaW5nID0gcXVlcnlTdHJpbmcgfHwgJyc7XG5cbiAgcmV0dXJuIHF1ZXJ5U3RyaW5nLnNwbGl0KCcmJykucmVkdWNlKChwLCBjKSA9PiB7XG4gICAgY29uc3QgcGFydHMgPSBjLnNwbGl0KCc9Jyk7XG4gICAgcFtkZWNvZGVVUklDb21wb25lbnQocGFydHNbMF0pXSA9XG4gICAgICBwYXJ0cy5sZW5ndGggPiAxID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcnRzLnNsaWNlKDEpLmpvaW4oJz0nKSkgOiAnJztcbiAgICByZXR1cm4gcDtcbiAgfSwge30pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgcGFyc2VRdWVyeVBhcmFtczogcGFyc2VRdWVyeVBhcmFtcyxcbiAgZ2V0RGF0YWJhc2VPcHRpb25zRnJvbVVSSTogZ2V0RGF0YWJhc2VPcHRpb25zRnJvbVVSSSxcbn07XG4iXX0=