"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createClient = createClient;
const parser = require('./PostgresConfigParser');
function createClient(uri, databaseOptions) {
  let dbOptions = {};
  databaseOptions = databaseOptions || {};
  if (uri) {
    dbOptions = parser.getDatabaseOptionsFromURI(uri);
  }
  for (const key in databaseOptions) {
    dbOptions[key] = databaseOptions[key];
  }
  const initOptions = dbOptions.initOptions || {};
  initOptions.noWarnings = process && process.env.TESTING;
  const pgp = require('pg-promise')(initOptions);
  const client = pgp(dbOptions);
  if (process.env.PARSE_SERVER_LOG_LEVEL === 'debug') {
    const monitor = require('pg-monitor');
    if (monitor.isAttached()) {
      monitor.detach();
    }
    monitor.attach(initOptions);
  }
  if (dbOptions.pgOptions) {
    for (const key in dbOptions.pgOptions) {
      pgp.pg.defaults[key] = dbOptions.pgOptions[key];
    }
  }
  return {
    client,
    pgp
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwYXJzZXIiLCJyZXF1aXJlIiwiY3JlYXRlQ2xpZW50IiwidXJpIiwiZGF0YWJhc2VPcHRpb25zIiwiZGJPcHRpb25zIiwiZ2V0RGF0YWJhc2VPcHRpb25zRnJvbVVSSSIsImtleSIsImluaXRPcHRpb25zIiwibm9XYXJuaW5ncyIsInByb2Nlc3MiLCJlbnYiLCJURVNUSU5HIiwicGdwIiwiY2xpZW50IiwiUEFSU0VfU0VSVkVSX0xPR19MRVZFTCIsIm1vbml0b3IiLCJpc0F0dGFjaGVkIiwiZGV0YWNoIiwiYXR0YWNoIiwicGdPcHRpb25zIiwicGciLCJkZWZhdWx0cyJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL1Bvc3RncmVzL1Bvc3RncmVzQ2xpZW50LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhcnNlciA9IHJlcXVpcmUoJy4vUG9zdGdyZXNDb25maWdQYXJzZXInKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUNsaWVudCh1cmksIGRhdGFiYXNlT3B0aW9ucykge1xuICBsZXQgZGJPcHRpb25zID0ge307XG4gIGRhdGFiYXNlT3B0aW9ucyA9IGRhdGFiYXNlT3B0aW9ucyB8fCB7fTtcblxuICBpZiAodXJpKSB7XG4gICAgZGJPcHRpb25zID0gcGFyc2VyLmdldERhdGFiYXNlT3B0aW9uc0Zyb21VUkkodXJpKTtcbiAgfVxuXG4gIGZvciAoY29uc3Qga2V5IGluIGRhdGFiYXNlT3B0aW9ucykge1xuICAgIGRiT3B0aW9uc1trZXldID0gZGF0YWJhc2VPcHRpb25zW2tleV07XG4gIH1cblxuICBjb25zdCBpbml0T3B0aW9ucyA9IGRiT3B0aW9ucy5pbml0T3B0aW9ucyB8fCB7fTtcbiAgaW5pdE9wdGlvbnMubm9XYXJuaW5ncyA9IHByb2Nlc3MgJiYgcHJvY2Vzcy5lbnYuVEVTVElORztcblxuICBjb25zdCBwZ3AgPSByZXF1aXJlKCdwZy1wcm9taXNlJykoaW5pdE9wdGlvbnMpO1xuICBjb25zdCBjbGllbnQgPSBwZ3AoZGJPcHRpb25zKTtcblxuICBpZiAocHJvY2Vzcy5lbnYuUEFSU0VfU0VSVkVSX0xPR19MRVZFTCA9PT0gJ2RlYnVnJykge1xuICAgIGNvbnN0IG1vbml0b3IgPSByZXF1aXJlKCdwZy1tb25pdG9yJyk7XG4gICAgaWYgKG1vbml0b3IuaXNBdHRhY2hlZCgpKSB7XG4gICAgICBtb25pdG9yLmRldGFjaCgpO1xuICAgIH1cbiAgICBtb25pdG9yLmF0dGFjaChpbml0T3B0aW9ucyk7XG4gIH1cblxuICBpZiAoZGJPcHRpb25zLnBnT3B0aW9ucykge1xuICAgIGZvciAoY29uc3Qga2V5IGluIGRiT3B0aW9ucy5wZ09wdGlvbnMpIHtcbiAgICAgIHBncC5wZy5kZWZhdWx0c1trZXldID0gZGJPcHRpb25zLnBnT3B0aW9uc1trZXldO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7IGNsaWVudCwgcGdwIH07XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE1BQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLHdCQUF3QixDQUFDO0FBRXpDLFNBQVNDLFlBQVksQ0FBQ0MsR0FBRyxFQUFFQyxlQUFlLEVBQUU7RUFDakQsSUFBSUMsU0FBUyxHQUFHLENBQUMsQ0FBQztFQUNsQkQsZUFBZSxHQUFHQSxlQUFlLElBQUksQ0FBQyxDQUFDO0VBRXZDLElBQUlELEdBQUcsRUFBRTtJQUNQRSxTQUFTLEdBQUdMLE1BQU0sQ0FBQ00seUJBQXlCLENBQUNILEdBQUcsQ0FBQztFQUNuRDtFQUVBLEtBQUssTUFBTUksR0FBRyxJQUFJSCxlQUFlLEVBQUU7SUFDakNDLFNBQVMsQ0FBQ0UsR0FBRyxDQUFDLEdBQUdILGVBQWUsQ0FBQ0csR0FBRyxDQUFDO0VBQ3ZDO0VBRUEsTUFBTUMsV0FBVyxHQUFHSCxTQUFTLENBQUNHLFdBQVcsSUFBSSxDQUFDLENBQUM7RUFDL0NBLFdBQVcsQ0FBQ0MsVUFBVSxHQUFHQyxPQUFPLElBQUlBLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDQyxPQUFPO0VBRXZELE1BQU1DLEdBQUcsR0FBR1osT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDTyxXQUFXLENBQUM7RUFDOUMsTUFBTU0sTUFBTSxHQUFHRCxHQUFHLENBQUNSLFNBQVMsQ0FBQztFQUU3QixJQUFJSyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0ksc0JBQXNCLEtBQUssT0FBTyxFQUFFO0lBQ2xELE1BQU1DLE9BQU8sR0FBR2YsT0FBTyxDQUFDLFlBQVksQ0FBQztJQUNyQyxJQUFJZSxPQUFPLENBQUNDLFVBQVUsRUFBRSxFQUFFO01BQ3hCRCxPQUFPLENBQUNFLE1BQU0sRUFBRTtJQUNsQjtJQUNBRixPQUFPLENBQUNHLE1BQU0sQ0FBQ1gsV0FBVyxDQUFDO0VBQzdCO0VBRUEsSUFBSUgsU0FBUyxDQUFDZSxTQUFTLEVBQUU7SUFDdkIsS0FBSyxNQUFNYixHQUFHLElBQUlGLFNBQVMsQ0FBQ2UsU0FBUyxFQUFFO01BQ3JDUCxHQUFHLENBQUNRLEVBQUUsQ0FBQ0MsUUFBUSxDQUFDZixHQUFHLENBQUMsR0FBR0YsU0FBUyxDQUFDZSxTQUFTLENBQUNiLEdBQUcsQ0FBQztJQUNqRDtFQUNGO0VBRUEsT0FBTztJQUFFTyxNQUFNO0lBQUVEO0VBQUksQ0FBQztBQUN4QiJ9